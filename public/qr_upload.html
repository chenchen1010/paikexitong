<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç§»åŠ¨ç«¯ç­¾åˆ°è¡¨ä¸Šä¼ </title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    
    body {
      background-color: #f7f7f7;
      color: #333;
      line-height: 1.6;
      padding: 20px;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
      text-align: center;
      color: #007aff;
    }
    
    .course-info {
      padding: 15px;
      background-color: #f2f2f7;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .course-info p {
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .course-info p:last-child {
      margin-bottom: 0;
    }
    
    .upload-area {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
      position: relative;
      cursor: pointer;
      min-height: 150px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .upload-area.active {
      border-color: #007aff;
      background-color: rgba(0, 122, 255, 0.05);
    }
    
    .upload-icon {
      font-size: 40px;
      margin-bottom: 15px;
    }
    
    .upload-text {
      font-size: 16px;
      margin-bottom: 5px;
    }
    
    .upload-hint {
      font-size: 12px;
      color: #999;
    }
    
    input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    
    .preview-container {
      display: none;
      margin-bottom: 20px;
    }
    
    .preview-title {
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .preview {
      width: 100%;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    
    .preview img {
      width: 100%;
      max-height: 300px;
      object-fit: contain;
    }
    
    .preview embed {
      width: 100%;
      height: 300px;
    }
    
    .btn {
      display: block;
      width: 100%;
      padding: 12px;
      font-size: 16px;
      font-weight: bold;
      color: #fff;
      background-color: #007aff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
      margin-bottom: 10px;
    }
    
    .btn:hover {
      background-color: #0062cc;
    }
    
    .btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .btn-cancel {
      background-color: #ff3b30;
    }
    
    .btn-cancel:hover {
      background-color: #d63031;
    }
    
    .status {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }
    
    .status.success {
      background-color: #e8f5e9;
      color: #2e7d32;
      display: block;
    }
    
    .status.error {
      background-color: #fdecea;
      color: #d32f2f;
      display: block;
    }
    
    .error-message {
      color: #ff3b30;
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>è¯¾ç¨‹ç­¾åˆ°è¡¨ä¸Šä¼ </h1>
    
    <div class="course-info" id="course-info">
      <p>æ­£åœ¨åŠ è½½è¯¾ç¨‹ä¿¡æ¯...</p>
    </div>
    
    <div class="upload-area" id="upload-area">
      <div class="upload-icon">ğŸ“±</div>
      <div class="upload-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
      <div class="upload-hint">æ”¯æŒJPG, PNG, PDFæ ¼å¼</div>
      <input type="file" id="file-upload" accept="image/jpeg,image/png,application/pdf">
    </div>
    
    <div class="preview-container" id="preview-container">
      <div class="preview-title">é¢„è§ˆ</div>
      <div class="preview" id="preview"></div>
    </div>
    
    <div class="status" id="status-message"></div>
    
    <button class="btn" id="upload-btn">ä¸Šä¼ ç­¾åˆ°è¡¨</button>
    <button class="btn btn-cancel" id="cancel-btn">å–æ¶ˆ</button>
    
    <div class="error-message" id="error-message"></div>
  </div>
  
  <script>
    // è·å–DOMå…ƒç´ 
    const courseInfoEl = document.getElementById('course-info');
    const uploadArea = document.getElementById('upload-area');
    const fileUpload = document.getElementById('file-upload');
    const previewContainer = document.getElementById('preview-container');
    const preview = document.getElementById('preview');
    const uploadBtn = document.getElementById('upload-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const statusMessage = document.getElementById('status-message');
    const errorMessage = document.getElementById('error-message');
    
    // è§£æURLå‚æ•°
    const params = new URLSearchParams(window.location.search);
    const courseId = params.get('courseId');
    
    // å½“å‰ä¸Šä¼ æ–‡ä»¶
    let currentFile = null;
    let courseData = null;
    
    // åˆå§‹åŒ–
    async function init() {
      if (!courseId) {
        showError('ç¼ºå°‘è¯¾ç¨‹IDå‚æ•°');
        return;
      }
      
      try {
        // è·å–è¯¾ç¨‹ä¿¡æ¯
        await fetchCourseInfo(courseId);
        
        // è®¾ç½®ä¸Šä¼ äº‹ä»¶
        setupUploadHandlers();
      } catch (error) {
        console.error('åˆå§‹åŒ–é”™è¯¯:', error);
        showError('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }
    
    // è·å–è¯¾ç¨‹ä¿¡æ¯
    async function fetchCourseInfo(courseId) {
      try {
        const response = await fetch(`/api/courses/${courseId}`);
        
        if (!response.ok) {
          throw new Error('è¯¾ç¨‹ä¸å­˜åœ¨');
        }
        
        courseData = await response.json();
        
        // æ˜¾ç¤ºè¯¾ç¨‹ä¿¡æ¯
        let storeInfo = '';
        let classroomInfo = '';
        
        // è·å–é—¨åº—ä¿¡æ¯
        if (courseData.storeId) {
          const storeResponse = await fetch('/api/stores');
          if (storeResponse.ok) {
            const stores = await storeResponse.json();
            const store = stores.find(s => s.id === courseData.storeId);
            if (store) {
              storeInfo = store.name;
            }
          }
        }
        
        // è·å–æ•™å®¤ä¿¡æ¯
        if (courseData.classroomId && courseData.storeId) {
          const classroomResponse = await fetch(`/api/stores/${courseData.storeId}/classrooms`);
          if (classroomResponse.ok) {
            const classrooms = await classroomResponse.json();
            const classroom = classrooms.find(c => c.id === courseData.classroomId);
            if (classroom) {
              classroomInfo = classroom.name;
            }
          }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        const dateStr = courseData.date ? new Date(courseData.date).toLocaleDateString('zh-CN') : 'æœªçŸ¥æ—¥æœŸ';
        
        // æ›´æ–°è¯¾ç¨‹ä¿¡æ¯æ˜¾ç¤º
        courseInfoEl.innerHTML = `
          <p><strong>è¯¾ç¨‹åç§°:</strong> ${courseData.name || 'æœªçŸ¥è¯¾ç¨‹'}</p>
          <p><strong>é—¨åº—:</strong> ${storeInfo || 'æœªçŸ¥é—¨åº—'}</p>
          <p><strong>æ•™å®¤:</strong> ${classroomInfo || 'æœªçŸ¥æ•™å®¤'}</p>
          <p><strong>æ—¥æœŸ:</strong> ${dateStr}</p>
        `;
      } catch (error) {
        console.error('è·å–è¯¾ç¨‹ä¿¡æ¯é”™è¯¯:', error);
        showError('è·å–è¯¾ç¨‹ä¿¡æ¯å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }
    
    // è®¾ç½®ä¸Šä¼ å¤„ç†å™¨
    function setupUploadHandlers() {
      // æ–‡ä»¶é€‰æ‹©å¤„ç†
      fileUpload.addEventListener('change', handleFileSelect);
      
      // ç‚¹å‡»ä¸Šä¼ æŒ‰é’®
      uploadBtn.addEventListener('click', uploadFile);
      
      // ç‚¹å‡»å–æ¶ˆæŒ‰é’®
      cancelBtn.addEventListener('click', () => {
        window.location.href = '/';
      });
      
      // æ‹–æ”¾å¤„ç†
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.add('active');
      });
      
      uploadArea.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove('active');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove('active');
        
        if (e.dataTransfer.files.length > 0) {
          handleFileSelect({ target: { files: e.dataTransfer.files } });
        }
      });
    }
    
    // å¤„ç†æ–‡ä»¶é€‰æ‹©
    function handleFileSelect(e) {
      const file = e.target.files[0];
      
      if (!file) return;
      
      // æ£€æŸ¥æ–‡ä»¶ç±»å‹
      const validTypes = ['image/jpeg', 'image/png', 'application/pdf'];
      if (!validTypes.includes(file.type)) {
        showError('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ï¼Œä»…æ”¯æŒJPGã€PNGå’ŒPDFæ–‡ä»¶');
        return;
      }
      
      // æ£€æŸ¥æ–‡ä»¶å¤§å° (10MBé™åˆ¶)
      if (file.size > 10 * 1024 * 1024) {
        showError('æ–‡ä»¶å¤ªå¤§ï¼Œè¯·é€‰æ‹©å°äº10MBçš„æ–‡ä»¶');
        return;
      }
      
      currentFile = file;
      showPreview(file);
      
      // æ¸…é™¤é”™è¯¯ä¿¡æ¯
      hideError();
    }
    
    // æ˜¾ç¤ºæ–‡ä»¶é¢„è§ˆ
    function showPreview(file) {
      preview.innerHTML = '';
      
      if (file.type.startsWith('image/')) {
        const img = document.createElement('img');
        img.onload = () => URL.revokeObjectURL(img.src);
        img.src = URL.createObjectURL(file);
        preview.appendChild(img);
      } else if (file.type === 'application/pdf') {
        const embed = document.createElement('embed');
        embed.type = 'application/pdf';
        embed.src = URL.createObjectURL(file);
        preview.appendChild(embed);
      }
      
      previewContainer.style.display = 'block';
    }
    
    // ä¸Šä¼ æ–‡ä»¶
    async function uploadFile() {
      if (!currentFile || !courseId) {
        showError('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
        return;
      }
      
      try {
        // åˆ›å»ºè¡¨å•æ•°æ®
        const formData = new FormData();
        formData.append('file', currentFile);
        
        // ç¦ç”¨ä¸Šä¼ æŒ‰é’®
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'ä¸Šä¼ ä¸­...';
        
        // éšè—çŠ¶æ€æ¶ˆæ¯
        statusMessage.className = 'status';
        statusMessage.style.display = 'none';
        
        const response = await fetch(`/api/courses/${courseId}/attendance`, {
          method: 'POST',
          body: formData
        });
        
        // æ¢å¤ä¸Šä¼ æŒ‰é’®
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'ä¸Šä¼ ç­¾åˆ°è¡¨';
        
        if (response.ok) {
          // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
          statusMessage.className = 'status success';
          statusMessage.textContent = 'ç­¾åˆ°è¡¨ä¸Šä¼ æˆåŠŸï¼';
          statusMessage.style.display = 'block';
          
          // é‡ç½®ä¸Šä¼ 
          currentFile = null;
          previewContainer.style.display = 'none';
          fileUpload.value = '';
        } else {
          let errorText = 'ä¸Šä¼ å¤±è´¥';
          try {
            const errorData = await response.json();
            errorText = errorData.error || errorText;
          } catch (e) {}
          
          showError(`ä¸Šä¼ å¤±è´¥: ${errorText}`);
        }
      } catch (error) {
        console.error('ä¸Šä¼ é”™è¯¯:', error);
        showError('ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•');
        
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'ä¸Šä¼ ç­¾åˆ°è¡¨';
      }
    }
    
    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
    }
    
    // éšè—é”™è¯¯ä¿¡æ¯
    function hideError() {
      errorMessage.style.display = 'none';
    }
    
    // åˆå§‹åŒ–é¡µé¢
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html> 