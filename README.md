# 多门店多教室排课系统

这是一个简单的排课系统，支持多门店、多教室的课程安排和学员管理。

## 功能

1. **周视图排课表**：左侧显示门店和教室，横向显示一周七天
2. **批量排课**：支持按照特定格式批量添加课程
3. **课程管理**：支持课程的增删改查
4. **学员管理**：支持学员的批量添加和删除
5. **签到表管理**：支持上传课程签到表，通过拖拽、粘贴或手机扫码上传
6. **打印签到表**：支持生成课程签到表并打印
7. **移动端上传**：支持通过手机扫码上传签到表

## 版本更新

### v2.0 更新日志 (2025-03-30)

1. **签到表上传增强**
   - 优化文件命名规则：采用"课程名称_日期_签到表.扩展名"格式
   - 添加时间戳防止文件重名覆盖
   - 图片预览优化：缩略图正确显示最新上传的图片
   - 支持多种上传方式：拖拽、粘贴、扫码上传

2. **移动端支持**
   - 添加移动端上传页面
   - 生成二维码，支持手机直接上传签到表
   - 优化移动端界面展示

3. **用户体验优化**
   - 优化上传和删除流程，减少不必要的提示
   - 改进图标：使用更直观的图标区分文件类型（图片使用📷，PDF使用📄）
   - 课程名称显示修正，确保正确显示课程信息
   - 缓存控制优化，确保每次显示最新图片

4. **外部访问支持**
   - 配置服务器允许外部IP访问
   - 支持通过公网IP访问系统

## 数据格式

### 批量添加课程格式
```
格式: 课程名称 门店 教室 教师 日期

示例: 书法 师大口店 教室1 张老师 2025-03-26
```

### 批量添加学员格式
每行一个学员姓名，例如：
```
小明
小红
小刚
```

## 技术栈

- 前端：HTML, CSS, JavaScript (原生)
- 后端：Node.js, Express
- 数据存储：JSON 文件

## 如何运行（本地开发环境）

1. 确保已安装 Node.js 环境
2. 安装依赖：`npm install`
3. 启动服务器：`node server.js`
4. 访问 `http://localhost:3000` 查看应用

## 数据存储

所有数据存储在 `data` 目录下的 JSON 文件中：

- `stores.json`：门店数据
- `classrooms.json`：教室数据
- `teachers.json`：教师数据
- `courses.json`：课程数据
- `students.json`：学员数据
- `attendance_records.json`：签到表记录

## 部署步骤（阿里云服务器 + 宝塔面板）

### 1. 上传项目文件
1. 登录宝塔面板
2. 进入文件管理，导航到 `/www/wwwroot/` 目录
3. 上传项目文件到该目录（可以是压缩包，然后解压）

### 2. 安装Node.js环境
1. 在宝塔面板中安装PM2管理器（会自动安装Node.js）
2. 如果PM2管理器安装有问题，可以通过命令行手动安装：
   ```bash
   # 设置npm使用淘宝镜像源
   npm config set registry https://registry.npmmirror.com
   
   # 全局安装PM2
   npm install -g pm2
   ```

### 3. 安装项目依赖
1. 进入项目目录：
   ```bash
   cd /www/wwwroot/排课最简单
   ```
2. 安装依赖：
   ```bash
   npm install
   ```

### 4. 设置数据目录权限
```bash
chmod -R 755 /www/wwwroot/排课最简单/data
```

### 5. 使用PM2启动应用
```bash
pm2 start server.js --name "排课系统" --max-memory-restart 1024M
```

### 6. 配置网站访问
1. 在宝塔面板中添加网站
2. 域名填写服务器IP
3. 备注填写"排课系统"
4. PHP版本选择"纯静态"

### 7. 配置反向代理
1. 在网站设置中选择"反向代理"
2. 添加反向代理，代理名称填写"api"，目标URL填写"http://127.0.0.1:3000"

### 8. 开放外部访问端口 (v2.0新增)
1. 登录阿里云控制台
2. 进入ECS实例的安全组配置
3. 添加入方向规则，开放TCP 3000端口
4. 在宝塔面板中的安全页面放行3000端口

## 维护提示

### 查看应用状态
```bash
pm2 list
```

### 查看应用日志
```bash
pm2 logs 排课系统
```

### 重启应用（代码修改后）
```bash
pm2 restart 排课系统
```

### 停止应用
```bash
pm2 stop 排课系统
```

### 设置开机自启
```bash
pm2 save
pm2 startup
```

### 数据备份
定期备份 `/www/wwwroot/排课最简单/data` 目录下的所有JSON文件，这些文件包含了所有系统数据。

## 故障排除

1. **应用无法启动**：检查PM2日志，确保所有依赖都已正确安装
2. **无法访问网站**：检查反向代理配置是否正确
3. **数据无法保存**：检查data目录的权限是否正确
4. **外部访问失败**：检查防火墙和安全组是否已开放3000端口
5. **签到表图片显示问题**：清除浏览器缓存或使用强制刷新

## 代码维护与更新

### 代码修改流程

1. **获取最新代码**
   ```bash
   cd /www/wwwroot/排课最简单
   git pull origin main  # 如果使用了Git管理代码
   ```

2. **修改代码**
   - 使用宝塔文件管理器直接编辑文件
   - 或通过SFTP工具（如FileZilla）上传修改后的文件
   - 或使用宝塔的在线编辑器修改代码

3. **更新系统**
   ```bash
   # 进入项目目录
   cd /www/wwwroot/排课最简单
   
   # 如果修改了前端代码，无需特殊操作
   
   # 如果修改了后端代码，需要重启服务
   pm2 restart 排课系统
   
   # 如果添加了新的依赖
   npm install
   pm2 restart 排课系统
   ```

4. **验证更新**
   - 访问网站检查功能是否正常
   - 查看日志确认无错误
   ```bash
   pm2 logs 排课系统
   ```

### 常见修改场景

1. **修改教室、课程或教师数据**
   - 直接编辑 `/www/wwwroot/排课最简单/data` 目录下的对应JSON文件
   - 修改后无需重启，系统会自动读取最新数据

2. **修改界面样式**
   - 编辑 `public` 目录下的CSS文件
   - 用户刷新浏览器即可看到更新

3. **修改业务逻辑**
   - 编辑 `routes` 或 `controllers` 目录下的JS文件
   - 修改后需要重启服务：`pm2 restart 排课系统`
